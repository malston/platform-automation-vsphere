{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 0,
  "links": [],
  "panels": [
    {
      "collapsed": true,
      "datasource": null,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 26,
      "panels": [
        {
          "content": "\n## Usage Service\nUsage Service allows for accurate billing of this foundation.\n\n### Overview\nUsage Service tracks the usage of applications, tasks and services pushed to a foundation. Usage Service works by using events generated by the Cloud Controller (CAPI) and then generating Daily, Monthly and Yearly records.\n\n### Deployment\nUsage Service is deployed via a cf pushed errand. \nIt deploys three apps to the System org and space:\n- app-usage-server\n- app-usage-scheduler\n- app-usage-worker\n\n### Usage Service Monitoring\nUsage Service pushes metrics associated with fetching and processing events from Cloud Controller (CAPI.) This is a good way to validate Usage Service is functioning properly.\n\n### General Monitoring Failure\nIf Usage Service is consistently failing, we recommend reaching out to support. In some cases irrecoverable data loss can occur if Usage Service is in a failed state for more than 31 days.\n\n### Usage Service Data\nData generated by Usage Service can be fetched using these [APIs](https://docs.pivotal.io/platform/application-service/operating/accounting-report.html) or via the AppsManger UI.\n\n\n\n",
          "datasource": null,
          "description": "General Information at the Usage Service component.",
          "gridPos": {
            "h": 15,
            "w": 24,
            "x": 0,
            "y": 1
          },
          "id": 20,
          "mode": "markdown",
          "timeFrom": null,
          "timeShift": null,
          "title": "About Usage Service",
          "transparent": true,
          "type": "text"
        }
      ],
      "title": "About Usage Service",
      "type": "row"
    },
    {
      "collapsed": false,
      "datasource": null,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 1
      },
      "id": 22,
      "panels": [],
      "title": "Alerts",
      "type": "row"
    },
    {
      "dashboardFilter": "",
      "dashboardTags": [],
      "datasource": null,
      "description": "",
      "folderId": -1,
      "gridPos": {
        "h": 6,
        "w": 10,
        "x": 0,
        "y": 2
      },
      "id": 14,
      "limit": 10,
      "nameFilter": "",
      "onlyAlertsOnDashboard": true,
      "show": "current",
      "sortOrder": 3,
      "stateFilter": [],
      "timeFrom": null,
      "timeShift": null,
      "title": "Usage Service alerts",
      "transparent": true,
      "type": "alertlist"
    },
    {
      "collapsed": false,
      "datasource": null,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 8
      },
      "id": 16,
      "panels": [],
      "title": "Service Level Indicators",
      "type": "row"
    },
    {
      "alert": {
        "alertRuleTags": {},
        "conditions": [
          {
            "evaluator": {
              "params": [
                172800
              ],
              "type": "gt"
            },
            "operator": {
              "type": "and"
            },
            "query": {
              "params": [
                "A",
                "5m",
                "now"
              ]
            },
            "reducer": {
              "params": [],
              "type": "avg"
            },
            "type": "query"
          }
        ],
        "executionErrorState": "alerting",
        "for": "5m",
        "frequency": "1m",
        "handler": 1,
        "message": "Usage Service has failed to fetch Events from Cloud Controller (CAPI) for the last 48 hour in {{deployment}}.\n\nThis is typically caused when Usage Service is running correctly, but can't reach CAPI. Common issues are Usage Service can not authenticate, Cloud Controller is in a bad state or incorrect network settings.\n\nTroubleshooting Steps:\n- Check CAPI. Try `cf curl /v2/app_usage_events`. The response should be 200 with recent events as the payload.\n- Check UAA. Make sure Usage Service can authenticate with CAPI. \n- Check Network.\n\n* If Usage Service fails to fetch events for 7 or more days, reach out to support.\n** If Usage Service fails to fetch events for more than 29 days, data loss can occur **",
        "name": "Usage Service Elevated Processing Lag",
        "noDataState": "no_data",
        "notifications": []
      },
      "aliasColors": {
        "Processing Lag (deployment: cf-3ad1cdf505c10b3a56f6)": "rgb(199, 14, 156)"
      },
      "bars": false,
      "dashLength": 10,
      "dashes": false,
      "datasource": null,
      "description": "Event Processing Lag displays the time between a usage event being generated in Cloud Controller and when this event is fetched by Usage Service. \nUnder normal conditions, this time should be about one hour. Usage Service has this hour offset to help ensure Cloud Controller events are in the correct states before fetching. \nOccasionally this lag can increase if there are network or Cloud Controller issues.  This occasional, increase lag is fine  as Usage Service will pick up at the last event in Cloud Controller.\n\nIf the lag length approaches 7 day, reach out to support for help. If the lag time length becomes greater than 29 days, data loss may occur. ",
      "fill": 1,
      "fillGradient": 0,
      "gridPos": {
        "h": 12,
        "w": 24,
        "x": 0,
        "y": 9
      },
      "hiddenSeries": false,
      "id": 4,
      "legend": {
        "alignAsTable": true,
        "avg": true,
        "current": false,
        "max": true,
        "min": false,
        "show": true,
        "total": false,
        "values": true
      },
      "lines": true,
      "linewidth": 2,
      "nullPointMode": "null",
      "options": {
        "dataLinks": []
      },
      "percentage": false,
      "pointradius": 2,
      "points": false,
      "renderer": "flot",
      "seriesOverrides": [],
      "spaceLength": 10,
      "stack": false,
      "steppedLine": false,
      "targets": [
        {
          "expr": "sum(usage_service_app_usage_event_cc_lag_seconds) by (deployment)",
          "interval": "",
          "intervalFactor": 1,
          "legendFormat": "Processing Lag (deployment: {{deployment}})",
          "refId": "A"
        }
      ],
      "thresholds": [
        {
          "colorMode": "critical",
          "fill": true,
          "line": true,
          "op": "gt",
          "value": 172800
        }
      ],
      "timeFrom": null,
      "timeRegions": [],
      "timeShift": null,
      "title": "Usage Service Event Processing Lag",
      "tooltip": {
        "shared": true,
        "sort": 0,
        "value_type": "individual"
      },
      "transparent": true,
      "type": "graph",
      "xaxis": {
        "buckets": null,
        "mode": "time",
        "name": null,
        "show": true,
        "values": []
      },
      "yaxes": [
        {
          "format": "s",
          "label": "Lag Time. 1 Hour Lag Normal.",
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": false
        }
      ],
      "yaxis": {
        "align": false,
        "alignLevel": null
      }
    },
    {
      "alert": {
        "alertRuleTags": {},
        "conditions": [
          {
            "evaluator": {
              "params": [
                0.99
              ],
              "type": "gt"
            },
            "operator": {
              "type": "and"
            },
            "query": {
              "params": [
                "A",
                "5m",
                "now"
              ]
            },
            "reducer": {
              "params": [],
              "type": "last"
            },
            "type": "query"
          }
        ],
        "executionErrorState": "alerting",
        "for": "6h",
        "frequency": "1m",
        "handler": 1,
        "message": "Event Fetching is failing for {{deployment}}.\n\nTypically, this means Usage Service is healthy, but CAPI is not returning the information it is requesting. Historically, this has happened due to either the network failing, or specifically the UAA component not authenticating this application successfully. \n\nTroubleshooting:\n- Check to see if you are able to query CAPI for /v2/app_usage_events and /v2/service_usage_events using the `cf curl` command. A failure would indicate there is a problem outside this application affecting the health of the foundation.\n- Check to see if UAA is working correctly.\n\n** If Event Fetching is failing for more than 7 days, reach out to support immediately. Data loss can occur if Event Fetching fails for more than 29 days. **",
        "name": "Usage Service Event Fetching Failures",
        "noDataState": "no_data",
        "notifications": []
      },
      "aliasColors": {
        "App GUID: f214922a-ccd6-41cd-a47a-fd1026cfc6e7": "semi-dark-blue",
        "Apps & Tasks Exit Code (deployment: cf-3ad1cdf505c10b3a56f6)": "blue",
        "Services Exit Code (deployment: cf-3ad1cdf505c10b3a56f6)": "purple"
      },
      "bars": false,
      "dashLength": 10,
      "dashes": false,
      "datasource": null,
      "decimals": 0,
      "description": "Exit Code Results\n\nUsage Service Event fetching runs every time new events are pulled and processed from Cloud Controller. If these Events are processed successfully into Usage Service, the job will emit the Exit Code of 0. If there is an error during event processing then job will emit an Exit Code of 1.\n\nFailures can occur if there is network connectivity issues with other components such as CAPI or UAA. This can occur with regular operation. Usage Service  can handle temporary downtime. If Usage Service recovers with in 29 days there will be no loss in report accuracy.  A longer down time period may result in data loss.\n\nWe recommend that if Usage Service is in a failure state for more than 7 days to reach out to support. ",
      "fill": 1,
      "fillGradient": 0,
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 21
      },
      "hiddenSeries": false,
      "id": 8,
      "legend": {
        "alignAsTable": true,
        "avg": false,
        "current": true,
        "max": false,
        "min": false,
        "show": true,
        "total": false,
        "values": true
      },
      "lines": true,
      "linewidth": 2,
      "nullPointMode": "null",
      "options": {
        "dataLinks": []
      },
      "percentage": false,
      "pointradius": 2,
      "points": false,
      "renderer": "flot",
      "seriesOverrides": [],
      "spaceLength": 10,
      "stack": false,
      "steppedLine": false,
      "targets": [
        {
          "expr": "sum(usage_service_app_usage_event_fetcher_job_exit_code) by (deployment)",
          "interval": "",
          "intervalFactor": 1,
          "legendFormat": "Apps & Tasks Exit Code (deployment: {{deployment}})",
          "refId": "A"
        },
        {
          "expr": "sum(usage_service_service_usage_event_fetcher_job_exit_code) by (deployment)",
          "interval": "",
          "legendFormat": "Services Exit Code (deployment: {{deployment}})",
          "refId": "B"
        }
      ],
      "thresholds": [
        {
          "colorMode": "critical",
          "fill": true,
          "line": true,
          "op": "gt",
          "value": 0.99
        }
      ],
      "timeFrom": null,
      "timeRegions": [],
      "timeShift": null,
      "title": "Usage Service Event Fetching Status",
      "tooltip": {
        "shared": true,
        "sort": 0,
        "value_type": "individual"
      },
      "transparent": true,
      "type": "graph",
      "xaxis": {
        "buckets": null,
        "mode": "time",
        "name": null,
        "show": true,
        "values": []
      },
      "yaxes": [
        {
          "decimals": 0,
          "format": "short",
          "label": "0 = success, 1 = failure",
          "logBase": 1,
          "max": "1.2",
          "min": "-0.2",
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": false
        }
      ],
      "yaxis": {
        "align": false,
        "alignLevel": null
      }
    },
    {
      "collapsed": false,
      "datasource": null,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 31
      },
      "id": 24,
      "panels": [],
      "title": "Supporting Metrics",
      "type": "row"
    },
    {
      "aliasColors": {
        "Failures (deployment: cf-3ad1cdf505c10b3a56f6)": "rgb(69, 69, 213)"
      },
      "bars": false,
      "dashLength": 10,
      "dashes": false,
      "datasource": null,
      "description": "Reports on the total number of jobs that have failed.\n\nUsage Service uses a scheduler/worker with delayed jobs architecture. These delayed jobs do all the processing and calculations for Usage Service in background. \n\nThese jobs can fail for a variety of reasons. These failure are generally temporary, in which case Usage Service can recover without data loss or corruption.\n\nIt is expected for this number to grow over time as this system keeps the record of the failed jobs.\n\nIf failures are periodic or ongoing it can signal an issues with the Usage Service system.\n\nThis information can help with diagnostics if others metrics are failing.\n",
      "fill": 1,
      "fillGradient": 0,
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 32
      },
      "hiddenSeries": false,
      "id": 2,
      "legend": {
        "alignAsTable": true,
        "avg": false,
        "current": true,
        "max": false,
        "min": false,
        "show": true,
        "total": false,
        "values": true
      },
      "lines": true,
      "linewidth": 2,
      "nullPointMode": "null",
      "options": {
        "dataLinks": []
      },
      "percentage": false,
      "pointradius": 2,
      "points": false,
      "renderer": "flot",
      "seriesOverrides": [],
      "spaceLength": 10,
      "stack": false,
      "steppedLine": false,
      "targets": [
        {
          "expr": "sum(usage_service_delayed_job_failures) by (deployment)",
          "interval": "",
          "intervalFactor": 1,
          "legendFormat": "Failures (deployment: {{deployment}})",
          "refId": "A"
        }
      ],
      "thresholds": [],
      "timeFrom": null,
      "timeRegions": [],
      "timeShift": null,
      "title": "Usage Service Async Job Failures",
      "tooltip": {
        "shared": true,
        "sort": 0,
        "value_type": "individual"
      },
      "transparent": true,
      "type": "graph",
      "xaxis": {
        "buckets": null,
        "mode": "time",
        "name": null,
        "show": true,
        "values": []
      },
      "yaxes": [
        {
          "decimals": 0,
          "format": "short",
          "label": "Total Historical Job Failures",
          "logBase": 1,
          "max": null,
          "min": "-0.2",
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": false
        }
      ],
      "yaxis": {
        "align": false,
        "alignLevel": null
      }
    },
    {
      "aliasColors": {
        "App Events Processed (deployment: cf-3ad1cdf505c10b3a56f6)": "dark-blue",
        "Service Events Processed (deployment: cf-3ad1cdf505c10b3a56f6)": "dark-purple",
        "Task Events Processed (deployment: cf-3ad1cdf505c10b3a56f6)": "dark-orange"
      },
      "bars": false,
      "dashLength": 10,
      "dashes": false,
      "datasource": "prometheus",
      "description": "Usage Service Events Processed displays the respective amount of successfully processed usage events.\nProcessed Events are events that are fetched from CAPI and then processed and stored in Usage Service for use by various later running jobs. This metric is a good indicator that Usage Service is running correctly as it is the first step in Usage Service tracking this Foundations usage.\n\nFor active Foundation, expect to see a lot of activity. For inactive Foundation, expect little activity. \n\nIf you notice little or no activity on this chart in an active Foundation, it could indicate an issue with Usage Service.  If you think this is happening for more than 7 day, reach out to support.\n\nIf Usage Service is in a failed state for more than 29 days, data loss may occur.",
      "fill": 1,
      "fillGradient": 0,
      "gridPos": {
        "h": 11,
        "w": 24,
        "x": 0,
        "y": 40
      },
      "hiddenSeries": false,
      "id": 6,
      "legend": {
        "alignAsTable": true,
        "avg": false,
        "current": false,
        "max": false,
        "min": false,
        "show": true,
        "total": true,
        "values": true
      },
      "lines": true,
      "linewidth": 2,
      "nullPointMode": "null",
      "options": {
        "dataLinks": []
      },
      "percentage": false,
      "pointradius": 2,
      "points": false,
      "renderer": "flot",
      "seriesOverrides": [],
      "spaceLength": 10,
      "stack": false,
      "steppedLine": false,
      "targets": [
        {
          "datasource": "prometheus",
          "expr": "sum(usage_service_app_usage_event_fetcher_job_processed_app_events) by (deployment)",
          "format": "time_series",
          "interval": "",
          "intervalFactor": 1,
          "legendFormat": "App Events Processed (deployment: {{deployment}})",
          "refId": "A"
        },
        {
          "datasource": "prometheus",
          "expr": "sum (usage_service_app_usage_event_fetcher_job_processed_task_events) by (deployment)",
          "format": "time_series",
          "interval": "",
          "intervalFactor": 1,
          "legendFormat": "Task Events Processed (deployment: {{deployment}})",
          "refId": "B"
        },
        {
          "expr": "sum(usage_service_service_usage_event_fetcher_job_processed_events) by (deployment)",
          "interval": "",
          "legendFormat": "Service Events Processed (deployment: {{deployment}})",
          "refId": "C"
        }
      ],
      "thresholds": [],
      "timeFrom": null,
      "timeRegions": [],
      "timeShift": null,
      "title": "Usage Service Events Processed",
      "tooltip": {
        "shared": true,
        "sort": 0,
        "value_type": "individual"
      },
      "transparent": true,
      "type": "graph",
      "xaxis": {
        "buckets": null,
        "mode": "time",
        "name": null,
        "show": true,
        "values": []
      },
      "yaxes": [
        {
          "decimals": 0,
          "format": "short",
          "label": "Count of Events Successfully Processed",
          "logBase": 1,
          "max": null,
          "min": "0",
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": false
        }
      ],
      "yaxis": {
        "align": false,
        "alignLevel": null
      }
    }
  ],
  "refresh": "5m",
  "schemaVersion": 22,
  "style": "dark",
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-14d",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "5s",
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "30m",
      "1h",
      "2h",
      "1d"
    ]
  },
  "timezone": "",
  "title": "Usage Service",
  "uid": "hw2-bam",
  "variables": {
    "list": []
  },
  "version": 105
}